#include <stdlib.h>
#include <stdint.h>
#include <malloc.h>

#define LOG_TAG "audio_hw_primary"
#define LOG_NDEBUG 0
#include <cutils/log.h>

#define min( a, b ) ( ( (a) < (b) ) ? (a) : (b) )
#define max( a, b ) ( ( (a) > (b) ) ? (a) : (b) )
#define abs( x ) ( ( (x) < 0 ) ? (-(x)) : (x) )

#define HP_AMP_FACTOR 0
#define HP_SIZE 21
/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 44100 Hz

* 0 Hz - 250 Hz
  gain = 1
  desired ripple = 5 dB
  actual ripple = 3.2211911302442195 dB

* 500 Hz - 22050 Hz
  gain = 0
  desired attenuation = -25 dB
  actual attenuation = -27.188461382262794 dB

*/
/*
#define LP_SIZE 171

static double f_lowpass[LP_SIZE] = {
  -0.022241133041661986,
  -0.0007082908490305683,
  -0.0007085154261696902,
  -0.0007016082254118031,
  -0.0006869149072712048,
  -0.0006640723847970066,
  -0.0006331683160413675,
  -0.0005941923889246683,
  -0.0005467164775798112,
  -0.0004902246197566042,
  -0.00042467211708159243,
  -0.00035051642166104857,
  -0.00026779031961006504,
  -0.00017564519636497378,
  -0.00007278377394186429,
  0.00003684249919131082,
  0.00015685746657217417,
  0.0002873292525217456,
  0.00042754509023293515,
  0.000577141217132589,
  0.0007363068657518264,
  0.0009052556511700865,
  0.0010836588197888214,
  0.0012707660334901148,
  0.0014662468871310627,
  0.0016713082647010278,
  0.0018917675457214196,
  0.002113666379091118,
  0.0023472649667414082,
  0.0025896167543811863,
  0.002840426873687856,
  0.003099180590939713,
  0.003365914115100764,
  0.003640701735311707,
  0.003923159416628146,
  0.004212571398232264,
  0.0045084441081637795,
  0.004810724089918204,
  0.0051190763535652675,
  0.0054373682707934716,
  0.005744322509971957,
  0.006073290025720577,
  0.00640346682541718,
  0.006734617917166793,
  0.007067438272512368,
  0.007402457153030221,
  0.007739492142279808,
  0.008077872681063997,
  0.00841707402415804,
  0.00875697937551227,
  0.009097405252136752,
  0.009437246167136704,
  0.009774231248068843,
  0.010110217816513568,
  0.010444336928008996,
  0.01077463968869853,
  0.01110132482439756,
  0.011424535106434394,
  0.01174362789502671,
  0.012057573843339227,
  0.01236551803229481,
  0.012666784030046887,
  0.012960216344428451,
  0.013243364257538312,
  0.013511299079715195,
  0.013743882969909454,
  0.014045250695993773,
  0.014282675025635412,
  0.014518034370420931,
  0.014743460923909001,
  0.014957918262870485,
  0.015160491853406195,
  0.015350692118767138,
  0.0155284725346261,
  0.015693700726342772,
  0.01584576232681069,
  0.01598387105246945,
  0.016107896544592545,
  0.016217914653533907,
  0.016315718232435775,
  0.016394494912065554,
  0.016461250282511185,
  0.016514188510628136,
  0.01655199123862744,
  0.016574383647291864,
  0.016581758763697635,
  0.016574383647291864,
  0.01655199123862744,
  0.016514188510628136,
  0.016461250282511185,
  0.016394494912065554,
  0.016315718232435775,
  0.016217914653533907,
  0.016107896544592545,
  0.01598387105246945,
  0.01584576232681069,
  0.015693700726342772,
  0.0155284725346261,
  0.015350692118767138,
  0.015160491853406195,
  0.014957918262870485,
  0.014743460923909001,
  0.014518034370420931,
  0.014282675025635412,
  0.014045250695993773,
  0.013743882969909454,
  0.013511299079715195,
  0.013243364257538312,
  0.012960216344428451,
  0.012666784030046887,
  0.01236551803229481,
  0.012057573843339227,
  0.01174362789502671,
  0.011424535106434394,
  0.01110132482439756,
  0.01077463968869853,
  0.010444336928008996,
  0.010110217816513568,
  0.009774231248068843,
  0.009437246167136704,
  0.009097405252136752,
  0.00875697937551227,
  0.00841707402415804,
  0.008077872681063997,
  0.007739492142279808,
  0.007402457153030221,
  0.007067438272512368,
  0.006734617917166793,
  0.00640346682541718,
  0.006073290025720577,
  0.005744322509971957,
  0.0054373682707934716,
  0.0051190763535652675,
  0.004810724089918204,
  0.0045084441081637795,
  0.004212571398232264,
  0.003923159416628146,
  0.003640701735311707,
  0.003365914115100764,
  0.003099180590939713,
  0.002840426873687856,
  0.0025896167543811863,
  0.0023472649667414082,
  0.002113666379091118,
  0.0018917675457214196,
  0.0016713082647010278,
  0.0014662468871310627,
  0.0012707660334901148,
  0.0010836588197888214,
  0.0009052556511700865,
  0.0007363068657518264,
  0.000577141217132589,
  0.00042754509023293515,
  0.0002873292525217456,
  0.00015685746657217417,
  0.00003684249919131082,
  -0.00007278377394186429,
  -0.00017564519636497378,
  -0.00026779031961006504,
  -0.00035051642166104857,
  -0.00042467211708159243,
  -0.0004902246197566042,
  -0.0005467164775798112,
  -0.0005941923889246683,
  -0.0006331683160413675,
  -0.0006640723847970066,
  -0.0006869149072712048,
  -0.0007016082254118031,
  -0.0007085154261696902,
  -0.0007082908490305683,
  -0.022241133041661986
};
*/

/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 44100 Hz

* 0 Hz - 200 Hz
  gain = 1
  desired ripple = 5 dB
  actual ripple = 1.4478941560410057 dB

* 400 Hz - 22050 Hz
  gain = 0
  desired attenuation = -15 dB
  actual attenuation = -24.055377378419344 dB

*/
/*
#define LP_SIZE 215

static double f_lowpass[LP_SIZE] = {
  -0.03204361012210235,
  -0.0013077692805266085,
  -0.0013282787775939957,
  -0.0013450457285890517,
  -0.0013578422487304275,
  -0.0013667687747843348,
  -0.001371270428452987,
  -0.0013713454418397555,
  -0.0013661934486813773,
  -0.0013572606702642698,
  -0.0013437401573374536,
  -0.0013244935007480254,
  -0.0013013545018669538,
  -0.0012726312296932694,
  -0.001238656050548405,
  -0.0011991826569950831,
  -0.0011544597681819929,
  -0.0011052017031547923,
  -0.0010454315466738205,
  -0.000991712749088441,
  -0.0009223320749719489,
  -0.0008472230802586497,
  -0.0007684115523105066,
  -0.0006849413088274061,
  -0.0005962852520844113,
  -0.000501521230183561,
  -0.00040047172716769483,
  -0.0002920451409703949,
  -0.00017749529728669782,
  -0.00005876878003190254,
  0.00006773414180620404,
  0.0001988981023839785,
  0.00033617734700495136,
  0.0004793876048737943,
  0.0006285438620235571,
  0.0007836775995716335,
  0.0009433071896695655,
  0.0011109683926396312,
  0.0012814155281770762,
  0.0014580893484747118,
  0.0016415421029462678,
  0.0018302337093943743,
  0.0020238432428304194,
  0.0022215179632098427,
  0.002423000562805535,
  0.0026277521077821106,
  0.0028376406971460048,
  0.003055753173256951,
  0.0032708043109304563,
  0.0034928768588788363,
  0.003717115416722194,
  0.003944437311576631,
  0.0041749622407731045,
  0.0044085070575099255,
  0.004645420823818478,
  0.004884103211055951,
  0.005126878164915146,
  0.005371992793664156,
  0.005619283991035679,
  0.005870106557559656,
  0.006123330518348673,
  0.006378227415088031,
  0.006632723893085385,
  0.006883769014269775,
  0.007123508908174519,
  0.007321990197446136,
  0.007633767619775978,
  0.007867832934652081,
  0.008113643062071083,
  0.00835874405343409,
  0.008601981828109232,
  0.008843361672682503,
  0.009082392309445088,
  0.00931937604573774,
  0.009552335432164537,
  0.009782195598258133,
  0.010009006759302035,
  0.010230814179287671,
  0.010449000356838201,
  0.0106627437274509,
  0.010871927431905177,
  0.011075854183815716,
  0.01127397853510528,
  0.011473899634001734,
  0.011643804424094215,
  0.011834940498379758,
  0.012014534066108026,
  0.012183167191274309,
  0.01234324230730691,
  0.012495824380727811,
  0.012641939302523168,
  0.012781576074798778,
  0.012915395087083312,
  0.013041541039560043,
  0.013158880032589521,
  0.013269752406733485,
  0.013371066441803942,
  0.013464191114121112,
  0.013548661681552112,
  0.013624449033909216,
  0.013691404249876093,
  0.013748173017451654,
  0.01379899970204469,
  0.013836449536807871,
  0.01386705244667461,
  0.01389024968154135,
  0.013904234613488246,
  0.013909012730087926,
  0.013904234613488246,
  0.01389024968154135,
  0.01386705244667461,
  0.013836449536807871,
  0.01379899970204469,
  0.013748173017451654,
  0.013691404249876093,
  0.013624449033909216,
  0.013548661681552112,
  0.013464191114121112,
  0.013371066441803942,
  0.013269752406733485,
  0.013158880032589521,
  0.013041541039560043,
  0.012915395087083312,
  0.012781576074798778,
  0.012641939302523168,
  0.012495824380727811,
  0.01234324230730691,
  0.012183167191274309,
  0.012014534066108026,
  0.011834940498379758,
  0.011643804424094215,
  0.011473899634001734,
  0.01127397853510528,
  0.011075854183815716,
  0.010871927431905177,
  0.0106627437274509,
  0.010449000356838201,
  0.010230814179287671,
  0.010009006759302035,
  0.009782195598258133,
  0.009552335432164537,
  0.00931937604573774,
  0.009082392309445088,
  0.008843361672682503,
  0.008601981828109232,
  0.00835874405343409,
  0.008113643062071083,
  0.007867832934652081,
  0.007633767619775978,
  0.007321990197446136,
  0.007123508908174519,
  0.006883769014269775,
  0.006632723893085385,
  0.006378227415088031,
  0.006123330518348673,
  0.005870106557559656,
  0.005619283991035679,
  0.005371992793664156,
  0.005126878164915146,
  0.004884103211055951,
  0.004645420823818478,
  0.0044085070575099255,
  0.0041749622407731045,
  0.003944437311576631,
  0.003717115416722194,
  0.0034928768588788363,
  0.0032708043109304563,
  0.003055753173256951,
  0.0028376406971460048,
  0.0026277521077821106,
  0.002423000562805535,
  0.0022215179632098427,
  0.0020238432428304194,
  0.0018302337093943743,
  0.0016415421029462678,
  0.0014580893484747118,
  0.0012814155281770762,
  0.0011109683926396312,
  0.0009433071896695655,
  0.0007836775995716335,
  0.0006285438620235571,
  0.0004793876048737943,
  0.00033617734700495136,
  0.0001988981023839785,
  0.00006773414180620404,
  -0.00005876878003190254,
  -0.00017749529728669782,
  -0.0002920451409703949,
  -0.00040047172716769483,
  -0.000501521230183561,
  -0.0005962852520844113,
  -0.0006849413088274061,
  -0.0007684115523105066,
  -0.0008472230802586497,
  -0.0009223320749719489,
  -0.000991712749088441,
  -0.0010454315466738205,
  -0.0011052017031547923,
  -0.0011544597681819929,
  -0.0011991826569950831,
  -0.001238656050548405,
  -0.0012726312296932694,
  -0.0013013545018669538,
  -0.0013244935007480254,
  -0.0013437401573374536,
  -0.0013572606702642698,
  -0.0013661934486813773,
  -0.0013713454418397555,
  -0.001371270428452987,
  -0.0013667687747843348,
  -0.0013578422487304275,
  -0.0013450457285890517,
  -0.0013282787775939957,
  -0.0013077692805266085,
  -0.03204361012210235
};
*/

/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 44100 Hz

* 0 Hz - 200 Hz
  gain = 1
  desired ripple = 5 dB
  actual ripple = 2.8314016242417233 dB

* 300 Hz - 22050 Hz
  gain = 0
  desired attenuation = -10 dB
  actual attenuation = -13.286444755649141 dB

*/

#define LP_SIZE 215

static double f_lowpass[LP_SIZE] = {
  -0.10799003767716706,
  0.0009618881347653982,
  0.0009654266779077981,
  0.0009743558217827753,
  0.0009882453305432664,
  0.0010070136078382452,
  0.0010320465627365473,
  0.0010600862299494688,
  0.0010941443234386405,
  0.0011320904274131954,
  0.0011753231859151843,
  0.0012221159251625843,
  0.001272429010395704,
  0.001326313841505907,
  0.0013824826342597018,
  0.001463647750924533,
  0.0015266761467970286,
  0.0016011820253029503,
  0.001679899659773308,
  0.0017628091576196191,
  0.0018508379486053242,
  0.0019392310478268313,
  0.0020356151098128903,
  0.00213429939503276,
  0.002236516005237666,
  0.0023415124431944755,
  0.002449977937970374,
  0.00256266010056726,
  0.00267912135575003,
  0.002801290283442671,
  0.0029210099218520617,
  0.0030479761476186465,
  0.003176976204362695,
  0.0033088083620253983,
  0.0034436879475351254,
  0.0035751923329587223,
  0.003723918208749659,
  0.003863749845884431,
  0.004006107518530777,
  0.00415081597198291,
  0.0042982967654829314,
  0.004448686092623955,
  0.004600379730339283,
  0.004754390801361875,
  0.004908168583538565,
  0.005065369242039605,
  0.005221989468331952,
  0.0053786190875314025,
  0.005532799337962525,
  0.005668011038585725,
  0.006052770022720961,
  0.006034977394493311,
  0.0061760387205398405,
  0.006330707537737033,
  0.0064899728926636775,
  0.006651346220364201,
  0.006812158432439696,
  0.00697477801191386,
  0.007136232597953597,
  0.00729841147893712,
  0.00745922652706888,
  0.007620433702047529,
  0.007782233119401304,
  0.007945280984193214,
  0.008115384386617058,
  0.008241533157005506,
  0.008404665034081072,
  0.008556915304527202,
  0.008706808020684282,
  0.008854556213897132,
  0.008998910919929362,
  0.009144320592173507,
  0.009284206870635112,
  0.009422671437363245,
  0.009558514754538951,
  0.009692631938111528,
  0.009824221693957512,
  0.009952282302859668,
  0.0100767544347538,
  0.010193874079816227,
  0.010315729629143263,
  0.010429286379271404,
  0.01054017153101164,
  0.010647506355496385,
  0.010750616906455656,
  0.010855546186351397,
  0.010945684972257848,
  0.011038890545551653,
  0.011128521941088184,
  0.011214368109010447,
  0.011295552690608295,
  0.011371498367330523,
  0.011443433480678587,
  0.011510236886349088,
  0.011574997457293857,
  0.011632541830263821,
  0.011687081117823595,
  0.011737472907276017,
  0.011784636429270448,
  0.011839347884462843,
  0.011812338916452796,
  0.011883120197479266,
  0.011919262016359258,
  0.01194534986144455,
  0.011964224966269489,
  0.011976839473333918,
  0.011985322326929183,
  0.011987371354881133,
  0.011985322326929183,
  0.011976839473333918,
  0.011964224966269489,
  0.01194534986144455,
  0.011919262016359258,
  0.011883120197479266,
  0.011812338916452796,
  0.011839347884462843,
  0.011784636429270448,
  0.011737472907276017,
  0.011687081117823595,
  0.011632541830263821,
  0.011574997457293857,
  0.011510236886349088,
  0.011443433480678587,
  0.011371498367330523,
  0.011295552690608295,
  0.011214368109010447,
  0.011128521941088184,
  0.011038890545551653,
  0.010945684972257848,
  0.010855546186351397,
  0.010750616906455656,
  0.010647506355496385,
  0.01054017153101164,
  0.010429286379271404,
  0.010315729629143263,
  0.010193874079816227,
  0.0100767544347538,
  0.009952282302859668,
  0.009824221693957512,
  0.009692631938111528,
  0.009558514754538951,
  0.009422671437363245,
  0.009284206870635112,
  0.009144320592173507,
  0.008998910919929362,
  0.008854556213897132,
  0.008706808020684282,
  0.008556915304527202,
  0.008404665034081072,
  0.008241533157005506,
  0.008115384386617058,
  0.007945280984193214,
  0.007782233119401304,
  0.007620433702047529,
  0.00745922652706888,
  0.00729841147893712,
  0.007136232597953597,
  0.00697477801191386,
  0.006812158432439696,
  0.006651346220364201,
  0.0064899728926636775,
  0.006330707537737033,
  0.0061760387205398405,
  0.006034977394493311,
  0.006052770022720961,
  0.005668011038585725,
  0.005532799337962525,
  0.0053786190875314025,
  0.005221989468331952,
  0.005065369242039605,
  0.004908168583538565,
  0.004754390801361875,
  0.004600379730339283,
  0.004448686092623955,
  0.0042982967654829314,
  0.00415081597198291,
  0.004006107518530777,
  0.003863749845884431,
  0.003723918208749659,
  0.0035751923329587223,
  0.0034436879475351254,
  0.0033088083620253983,
  0.003176976204362695,
  0.0030479761476186465,
  0.0029210099218520617,
  0.002801290283442671,
  0.00267912135575003,
  0.00256266010056726,
  0.002449977937970374,
  0.0023415124431944755,
  0.002236516005237666,
  0.00213429939503276,
  0.0020356151098128903,
  0.0019392310478268313,
  0.0018508379486053242,
  0.0017628091576196191,
  0.001679899659773308,
  0.0016011820253029503,
  0.0015266761467970286,
  0.001463647750924533,
  0.0013824826342597018,
  0.001326313841505907,
  0.001272429010395704,
  0.0012221159251625843,
  0.0011753231859151843,
  0.0011320904274131954,
  0.0010941443234386405,
  0.0010600862299494688,
  0.0010320465627365473,
  0.0010070136078382452,
  0.0009882453305432664,
  0.0009743558217827753,
  0.0009654266779077981,
  0.0009618881347653982,
  -0.10799003767716706
};



static double f_highpass[HP_SIZE] = {
	-0.039420708941675951,
	-0.0059291135261694949,
	0.014309970166929349,
	0.04069053431983697,
	0.057621969562200469,
	0.048435837962310657,
	0.0043496326500793037,
	-0.069329129702720121,
	-0.15278615494732953,
	-0.21873277979801881,
	0.7562085221325483,
	-0.21873277979801881,
	-0.15278615494732953,
	-0.069329129702720121,
	0.0043496326500793037,
	0.048435837962310657,
	0.057621969562200469,
	0.04069053431983697,
	0.014309970166929349,
	-0.0059291135261694949,
	-0.039420708941675951
};


static void audio_fir_init()
{
}


static short in[2][2048*2*2] = { { 0 } };
static void FirFixed( short* buffer_out, short* buffer_in, int len, double* coeffs, int coeffslen, float gain )
{
	int i;
	int n;
	int j;

	// Put new data into buffer
	for( i=0; i<len; i++ ){
		in[0][coeffslen-1 + i] = buffer_in[i * 2 + 0];
		in[1][coeffslen-1 + i] = buffer_in[i * 2 + 1];
	}

	for ( n = 0; n < len; n++ ) {
		double acc0 = 0.0f;
		double acc1 = 0.0f;

		for ( j = 0; j<coeffslen; j++ ) {
			acc0 += ( (double)(in[0][coeffslen - 1 + n - j]) / 32768.0 ) * coeffs[j];
			acc1 += ( (double)(in[1][coeffslen - 1 + n - j]) / 32768.0 ) * coeffs[j];
		}

		acc0 = min( max( -0.999, acc0 * gain ), 0.999 );
		acc1 = min( max( -0.999, acc1 * gain ), 0.999 );

		buffer_out[n * 2 + 0] = (short)( acc0 * 32768.0 );
		buffer_out[n * 2 + 1] = (short)( acc1 * 32768.0 );
	}

	// Shift data back in time for next pass
	for( i=0; i<coeffslen-1; i++ ){
		in[0][i] = in[0][len + i];
		in[1][i] = in[1][len + i];
	}

}


void audio_fir_highpass( short* samples_out, short* samples_in, int nSamples, float gain )
{
	FirFixed( samples_out, samples_in, nSamples, f_highpass, HP_SIZE, gain );
}


void audio_fir_lowpass( short* samples_out, short* samples_in, int nSamples, float gain )
{
	FirFixed( samples_out, samples_in, nSamples, f_lowpass, LP_SIZE, gain );
}
